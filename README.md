# 📊 Google Sheets 全自動記帳系統 (國泰世華版)

這是一個基於 Google Apps Script (GAS) 開發的全自動記帳工具。專為習慣使用 **國泰世華銀行** 信用卡的用戶設計，能夠自動抓取 Gmail 中的消費通知信件，並整合 **iOS 捷徑 (Shortcuts)** 進行現金或手動記帳。

系統會自動將資料匯整至 Google Sheets，提供年度戰情室報表與互動式明細查詢。

## ✨ 主要功能

* **📧 自動抓取信件**：自動掃描 Gmail 中來自國泰世華的「消費彙整通知」，解析金額、日期與商家。
* **📱 iOS 捷徑整合**：提供 API 接口 (`doPost`)，配合 iPhone 捷徑即可快速記錄現金花費 (支援 JSON 格式)。
* **🤖 智慧自動分類**：內建關鍵字對照表，自動將消費歸類為「餐飲、交通、購物、醫療...」等 8 大類別。
* **🔄 倒序自動排列**：新加入的資料永遠顯示在最上方 (Row 2)，並自動依照日期排序，查帳不需滑到最底。
* **🎨 自動美化格式**：寫入資料時自動清除格式、統一字體並加上 `NT$` 金額符號。
* **📊 年度戰情室**：自動生成類似樞紐分析表的年度統計，按月份與類別統計總花費。
* **🔍 互動查詢面板**：提供專屬查詢介面，可篩選特定年份與類別的明細，並即時計算總金額。

## 🛠️ 安裝方式

### 1. 建立 Google Sheet
1. 新增一個 Google Sheet 試算表。
2. 點選上方選單的 **擴充功能 (Extensions)** > **Apps Script**。

### 2. 部署程式碼
1. 將本專案的 `.gs` 程式碼複製並貼上到編輯器中。
2. 儲存專案。
3. 重新整理 Google Sheet 頁面，上方會出現 **「💰 記帳小幫手」** 選單。
4. 點選 **「💰 記帳小幫手」** > **「📩 立即執行抓信」** (首次執行需授權 Google 權限)。

### 3. 設定自動化觸發 (Triggers)
程式碼內建自動設定功能：
* 點選 **「💰 記帳小幫手」** > **「🔄 強制更新所有報表」** 或執行一次抓信，系統會自動註冊「每小時」檢查一次信件的觸發器。

---

## 📱 iOS 捷徑 (Shortcuts) 設定教學

若要使用 iPhone 快速記帳，請依照以下步驟設定 Web App：

### 1. 取得 API 網址
1. 在 Apps Script 編輯器右上角點選 **「部署」 (Deploy)** > **「新增部署作業」 (New deployment)**。
2. 點選齒輪圖示 > **「網頁應用程式」 (Web app)**。
3. 設定如下：
    * **執行身分 (Execute as)**: `我 (Me)`
    * **誰可以存取 (Who has access)**: `任何人 (Anyone)` (⚠️這很重要，否則捷徑會報錯)
4. 複製產生的 **網頁應用程式網址 (Web App URL)**。

### 2. iPhone 捷徑設定
在 iOS 捷徑 App 中建立新捷徑，加入 **「取得 URL 的內容 (Get Contents of URL)」** 動作：

* **URL**: 貼上剛剛複製的網址
* **方法 (Method)**: `POST`
* **要求本文 (Request Body)**: `JSON`
* **加入欄位**:
    * `amount` (數字): 輸入金額 (可設為「每次詢問」)
    * `type` (文字): 例如 `提款`、`現金` (主要用來觸發分類)
    * `note` (文字): 例如 `ATM提款`、`午餐` (作為備註內容)

⚙️ 自定義設定
你可以在程式碼最上方的 CONFIG 區域修改設定：

關鍵字分類 (CATEGORIES)：依照你的消費習慣，將商家關鍵字加入對應的陣列中。

搜尋語法 (EMAIL_QUERY)：若需更改抓取的信件來源，可在此修改 Gmail 搜尋語法。

📝 版本紀錄
v6.4: 修復繼承格式問題、新增自動加上 NT$ 符號、強化抓信後的自動排序功能。

v6.3: 優化 iOS 捷徑寫入邏輯，解決背景顏色殘留問題。

v6.0: 整合選單與自動觸發器安裝。

v5.0: 實作倒序插入 (新資料在最上方)。

⚠️ 注意事項
本腳本專為 國泰世華銀行 的通知信格式撰寫，若使用其他銀行，需自行修改 HTML 解析邏輯 (processThreadsBatch 函式)。

請勿將部署的 Web App URL 洩漏給他人，以免被惡意寫入資料。

Created by [你的名字/GitHub ID]
